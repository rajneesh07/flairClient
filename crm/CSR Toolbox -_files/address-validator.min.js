!function($){"use strict";function AddressValidator($element,options){this.options=$.extend({},$.fn.addressValidator.defaults,options),this.$element=$element,this.appId=this.$element.data("app-id"),this.browserLanguage=this.$element.data("browser-language").toUpperCase(),this.noMatch=this.$element.data("no-match")||"No match",this.init(),$.subscribe("reload-address-validator",$.proxy(this.init,this))}AddressValidator.prototype={constructor:AddressValidator,init:function(){this.$autocompletePostcode=this.$element.find(this.options.autocompletePostcode),this.$autocompleteCity=this.$element.find(this.options.autocompleteCity),this.$autocompleteStreet=this.$element.find(this.options.autocompleteStreet),this.$autocompleteHousenumber=this.$element.find(this.options.autocompleteHousenumber),this.$autocompleteCountry=this.$element.find(this.options.autocompleteCountry);{var addressValidator=this;this.options}this.$autocompletePostcode.on("change",$.proxy(this.onPostalCodeChange,this)),this.$autocompleteCity.on("focus",function(){$(this).trigger("change")}),this.$autocompleteCity.on("change",$.proxy(this.onAddressChange,this)),this.$element.find("input").on("blur",function(){$(addressValidator.options.noSuggestions).parent().hide()}),this.$autocompleteCity.address_autocomplete({serviceUrl:"/acs/rest/cities",paramName:"town",minChars:0,ajaxSettings:{headers:{"x-och-appid":this.appId}},self:this,transformResult:function(response){return{suggestions:$.map(JSON.parse(response).cities,function(dataItem){return{value:dataItem.town,data:dataItem.town}})}},onSearchStart:function(){return $(this).address_autocomplete().disabled===!0?($(this).address_autocomplete().clear(),!1):void $(this).addClass("autocomplete-loader")},onSearchComplete:function(query,suggestions){1===suggestions.length&&suggestions[0].value!==this.forcedCity&&(this.forcedCity=suggestions[0].value,$(this).val(this.forcedCity),$(this).address_autocomplete("hide")),$(this).removeClass("autocomplete-loader"),this.suggestions=suggestions},onSearchError:function(){$(this).removeClass("autocomplete-loader"),(void 0==this.suggestions||this.suggestions.length>1&&""!=$(this).val())&&addressValidator.matchNotFound(this)}}),this.$autocompleteStreet.on("focus",function(){$(this).trigger("change")}),this.$autocompleteStreet.on("change",$.proxy(this.onAddressChange,this)),this.$autocompleteStreet.address_autocomplete({serviceUrl:"/acs/rest/streets",paramName:"streetName",minChars:2,ajaxSettings:{headers:{"x-och-appid":this.appId}},self:this,transformResult:function(response){return{suggestions:$.map(JSON.parse(response).streets,function(dataItem){return{value:dataItem.streetName,data:dataItem.streetName}})}},onSearchStart:function(){return $(this).address_autocomplete().disabled===!0?($(this).address_autocomplete().clear(),!1):void $(this).addClass("autocomplete-loader")},onSearchComplete:function(query,suggestions){1===suggestions.length&&suggestions[0].value!==this.forcedStreet&&(this.forcedStreet=suggestions[0].value,$(this).val(this.forcedStreet),$(this).address_autocomplete("hide")),$(this).removeClass("autocomplete-loader")},onSearchError:function(){$(this).removeClass("autocomplete-loader"),addressValidator.matchNotFound(this)}}),this.$autocompleteHousenumber.on("focus",function(){$(this).trigger("change")}),this.$autocompleteHousenumber.on("change",$.proxy(this.onAddressChange,this)),this.$autocompleteHousenumber.address_autocomplete({serviceUrl:"/acs/rest/addresses",paramName:"houseNumber",minChars:1,ajaxSettings:{headers:{"x-och-appid":this.appId}},self:this,transformResult:function(response){return{suggestions:$.map(JSON.parse(response).adresses,function(dataItem){return{value:dataItem.houseNumber,data:dataItem.houseNumber}})}},onSearchStart:function(){return $(this).address_autocomplete().disabled===!0?($(this).address_autocomplete().clear(),!1):void $(this).addClass("autocomplete-loader")},onSearchComplete:function(query,suggestions){1===suggestions.length&&suggestions[0].value!==this.forcedHouse&&(this.forcedHouse=suggestions[0].value,$(this).val(this.forcedHouse),$(this).address_autocomplete("hide")),$(this).removeClass("autocomplete-loader")},onSearchError:function(){$(this).removeClass("autocomplete-loader"),addressValidator.matchNotFound(this)}}),this.$autocompleteCountry.on("change",$.proxy(this.onCountryChange,this)),this.$autocompleteCountry.trigger("change"),this.$autocompleteCity.trigger("change"),this.$autocompleteStreet.trigger("change"),this.$autocompleteHousenumber.trigger("change")},onCountryChange:function(event){var disableGroup=$(event.currentTarget).closest(this.options.autocompletePerson).find(this.options.addressGroup);-1===$.inArray(event.currentTarget.value,["LI","CH"])?(this.setAutocompleteState(disableGroup,"disable"),disableGroup.find(".address-validation-error").addClass("hidden"),disableGroup.find(".address-validation-error").find(".postcode, .city, .street, .housenumber").addClass("hidden"),disableGroup.find("#id_address_validated").val("not_validated")):this.setAutocompleteState(disableGroup,"enable")},onPostalCodeChange:function(event){var $addressGroup=$(event.currentTarget).closest(this.options.addressGroup),validation_disabled=$addressGroup.find(this.options.autocompleteCity).address_autocomplete().disabled;validation_disabled||$addressGroup.find(this.options.autocompleteCity).val(""),this.addressChanged($(event.currentTarget),validation_disabled,this)},setAutocompleteState:function($addressGroup,value){$addressGroup.find(this.options.autocompletePostcode).address_autocomplete(value),$addressGroup.find(this.options.autocompleteCity).address_autocomplete(value),$addressGroup.find(this.options.autocompleteStreet).address_autocomplete(value),$addressGroup.find(this.options.autocompleteHousenumber).address_autocomplete(value)},onAddressChange:function(event){var validation_disabled=$(event.currentTarget).address_autocomplete().disabled;this.addressChanged($(event.currentTarget),validation_disabled,this)},updateParams:function($element,addressInformation){$element.attr("class").indexOf("city")>-1&&$element.address_autocomplete("setOptions",{params:{maxRows:"100",language:this.browserLanguage,zipCode:addressInformation[0].val().trim()}}),$element.attr("class").indexOf("street")>-1&&$element.address_autocomplete("setOptions",{params:{maxRows:"100",language:this.browserLanguage,zipCode:addressInformation[0].val().trim(),town:addressInformation[1].val().trim()}}),$element.attr("class").indexOf("housenumber")>-1&&$element.address_autocomplete("setOptions",{params:{maxRows:"100",language:this.browserLanguage,zipCode:addressInformation[0].val().trim(),town:addressInformation[1].val().trim(),streetName:addressInformation[2].val().trim()}})},addressChanged:function($element,validation_disabled,self){var $addressGroup=$element.closest(self.options.addressGroup),$personInformation=$element.closest(self.options.autocompletePerson),addressInformation=[$addressGroup.find(self.options.autocompletePostcode),$addressGroup.find(self.options.autocompleteCity),$addressGroup.find(self.options.autocompleteStreet),$addressGroup.find(self.options.autocompleteHousenumber),$addressGroup.find(self.options.autocompleteCountry)],firstName=$personInformation.find(self.options.autocompleteFirstname).val(),lastName=$personInformation.find(self.options.autocompleteLastname).val(),companyName=$personInformation.find(self.options.autocompleteCompanyname).val();(""===companyName||"undefined"==typeof companyName)&&(companyName=$personInformation.find(self.options.autocompleteCompanyname).html()),companyName?(lastName=companyName,firstName=""):((""===firstName||"undefined"==typeof firstName)&&(firstName=$personInformation.find(self.options.autocompleteFirstname).html()),(""===lastName||"undefined"==typeof lastName)&&(lastName=$personInformation.find(self.options.autocompleteLastname).html()));var personInformation=[firstName,lastName];self.hasAllRequiredAddressFields(addressInformation,self)&&!validation_disabled&&""!==personInformation[1]&&"undefined"!=typeof personInformation[1]&&null!==personInformation[1]&&self.validateAddress(addressInformation,personInformation,$addressGroup,self),this.updateParams($element,addressInformation)},hasAllRequiredAddressFields:function(addressInformation,self){var state="enable";return addressInformation[self.options.autocompleteCountryPos].length>0&&-1===$.inArray(addressInformation[self.options.autocompleteCountryPos].find(":selected").val(),self.options.autocompleteCountries)&&(state="disable"),addressInformation[self.options.autocompletePostcodePos].address_autocomplete(state),addressInformation[self.options.autocompleteCityPos].address_autocomplete(state),addressInformation[self.options.autocompleteStreetPos].address_autocomplete(state),addressInformation[self.options.autocompleteHouseNumberPos].address_autocomplete(state),4!==addressInformation[self.options.autocompletePostcodePos].val().trim().length?(addressInformation[self.options.autocompleteCityPos].address_autocomplete("disable"),addressInformation[self.options.autocompleteStreetPos].address_autocomplete("disable"),addressInformation[self.options.autocompleteHouseNumberPos].address_autocomplete("disable"),!1):addressInformation[self.options.autocompleteCityPos].val().trim().length<1?(addressInformation[self.options.autocompleteStreetPos].address_autocomplete("disable"),addressInformation[self.options.autocompleteHouseNumberPos].address_autocomplete("disable"),!1):addressInformation[self.options.autocompleteStreetPos].val().trim().length<2?(addressInformation[self.options.autocompleteHouseNumberPos].address_autocomplete("disable"),!1):0===addressInformation[self.options.autocompleteHouseNumberPos].val().trim().length?!1:!0},validateAddress:function(addressInformation,personInformation,$addressGroup,self){var post_data={historicalSearch:!1,searchByPoBox:!1,person:{name:personInformation[1].trim(),firstName:" "},postalServed:!1,houseNumber:addressInformation[self.options.autocompleteHouseNumberPos].val().trim(),streetName:addressInformation[self.options.autocompleteStreetPos].val().trim(),city:{town:addressInformation[self.options.autocompleteCityPos].val().trim(),zipCode:addressInformation[self.options.autocompletePostcodePos].val().trim()},maxRows:100,searchLanguage:this.browserLanguage,correlationId:this.generateUUID(),rootCorrelationId:"address_validator"};personInformation[0]&&(post_data.person.firstName=personInformation[0].trim()),this.validatePerson(post_data,$addressGroup)},validatePerson:function(post_data,$addressGroup){$.ajax({type:"POST",url:"/acs/rest/person",data:JSON.stringify(post_data),contentType:"application/json",dataType:"json",headers:{"x-och-appid":this.appId},success:function(response_data){var person=response_data.persons[0],$errorElement=$addressGroup.find(".address-validation-error");$errorElement.find(".postcode, .city, .street, .housenumber").addClass("hidden"),person.zipValid&&person.townValid&&person.streetValid&&person.houseNumerValid?($addressGroup.find(".address-validation-error").addClass("hidden"),$addressGroup.find(".address-validation-error .firstname").addClass("hidden"),$addressGroup.find(".address-validation-error .lastname").addClass("hidden"),$addressGroup.find("#id_address_validated").val("valid")):($errorElement.removeClass("hidden"),person.zipValid||$errorElement.find(".postcode").removeClass("hidden"),person.townValid||$errorElement.find(".city").removeClass("hidden"),person.streetValid||$errorElement.find(".street").removeClass("hidden"),person.houseNumerValid||$errorElement.find(".housenumber").removeClass("hidden"),$addressGroup.find("#id_address_validated").val("invalid"))}})},generateUUID:function(){var d=(new Date).getTime(),uuid="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=(d+16*Math.random())%16|0;return d=Math.floor(d/16),("x"==c?r:3&r|8).toString(16)});return uuid},matchNotFound:function(element){var suggestions=$(element).address_autocomplete().suggestionsContainer;$(element).is(":focus")&&($(suggestions).html('<div class="autocomplete-no-suggestion">'+this.noMatch+"</div>"),$(suggestions).show())}},$.fn.addressValidator=function(options){var useOptions={};return void 0!==options&&(useOptions=options),this.each(function(){var $this=$(this),data=$this.data("address-validator");data||($this.data("address-validator",data=new AddressValidator($this,useOptions)),useOptions={})})},$.fn.addressValidator.defaults={autocompletePostcode:".autocorrect.postcode",autocompleteCity:".autocorrect.city",autocompleteStreet:".autocorrect.street",autocompleteHousenumber:".autocorrect.housenumber",autocompleteFirstname:".firstname",autocompleteLastname:".lastname",autocompleteCompanyname:".companyname",autocompletePerson:".person-information",autocompleteCountry:".autocorrect.country",addressGroup:".address-group",addressValidationError:".address-validation-error .postcode",noSuggestions:".autocomplete-no-suggestion",autocompletePostcodePos:0,autocompleteCityPos:1,autocompleteStreetPos:2,autocompleteHouseNumberPos:3,autocompleteCountryPos:4,autocompleteCountries:["LI","CH"]},$.fn.addressValidator.Constructor=AddressValidator,$(function(){$("[data-address-validator]").addressValidator()})}(jQuery);